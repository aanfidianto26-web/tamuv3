<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buku Tamu - SMAN 1 Kota Malang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Base Styles */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .form-shadow {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        /* Touch-friendly buttons */
        button, .btn {
            min-height: 48px;
            min-width: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }
        
        button:active, .btn:active {
            transform: scale(0.98);
        }
        
        /* Touch-friendly form inputs */
        input, textarea, select {
            min-height: 48px;
            font-size: 16px; /* Prevents zoom on iOS */
            touch-action: manipulation;
            -webkit-appearance: none;
            border-radius: 8px;
        }
        
        /* Loading Animation */
        .loading {
            display: none;
        }
        .loading.show {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Success Message */
        .success-message {
            display: none;
            animation: slideIn 0.5s ease-out;
        }
        .success-message.show {
            display: block;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Panel States */
        .admin-panel {
            display: none;
        }
        .admin-panel.show {
            display: block;
        }
        .guest-book {
            display: block;
        }
        .guest-book.hide {
            display: none;
        }
        
        /* Print Modal */
        .print-modal {
            display: none;
        }
        .print-modal.show {
            display: flex;
        }
        
        /* Thank You Notification */
        .thank-you-notification {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: linear-gradient(135deg, #10B981, #059669);
            color: white;
            border-radius: 16px;
            padding: 20px 24px;
            box-shadow: 0 20px 40px -12px rgba(16, 185, 129, 0.4);
            text-align: left;
            min-width: 320px;
            max-width: 400px;
        }
        .thank-you-notification.show {
            display: block;
            animation: slideInRight 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .thank-you-notification.hide {
            animation: slideOutRight 0.4s ease-in-out forwards;
        }
        @keyframes slideInRight {
            0% {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }
        @keyframes slideOutRight {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(100%) scale(0.8);
            }
        }

        /* Success Popup - Mobile Optimized */
        .success-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: white;
            border-radius: 20px;
            padding: 30px 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .success-popup.show {
            display: block;
            animation: popupShow 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        .success-popup.hide {
            animation: popupHide 0.3s ease-in-out forwards;
        }
        @keyframes popupShow {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        @keyframes popupHide {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.8);
            }
        }
        
        /* Checkmark Animation */
        .checkmark-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981, #059669);
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: checkmarkBounce 0.6s ease-out 0.2s both;
        }
        .checkmark {
            width: 40px;
            height: 40px;
            color: white;
            animation: checkmarkDraw 0.4s ease-out 0.4s both;
        }
        @keyframes checkmarkBounce {
            0% {
                opacity: 0;
                transform: scale(0);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes checkmarkDraw {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        /* Popup Overlay */
        .popup-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9998;
        }
        .popup-overlay.show {
            display: block;
            animation: overlayFadeIn 0.3s ease-out;
        }
        @keyframes overlayFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Offline Indicator */
        .offline-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f59e0b;
            color: white;
            text-align: center;
            padding: 8px;
            font-size: 14px;
            z-index: 10000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        .offline-indicator.show {
            transform: translateY(0);
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 640px) {
            body {
                padding: 0;
            }
            
            .gradient-bg {
                padding: 16px 12px;
            }
            
            /* Mobile notification adjustments */
            .thank-you-notification {
                top: 16px;
                right: 16px;
                left: 16px;
                min-width: auto;
                max-width: none;
            }
            
            /* Header adjustments */
            .bg-white\/10 h1 {
                font-size: 2.5rem !important;
            }
            
            .bg-white\/10 h2 {
                font-size: 1.75rem !important;
            }
            
            .bg-white\/10 p {
                font-size: 1.25rem !important;
            }
            
            /* Form container */
            .form-shadow {
                margin: 0 auto;
                padding: 24px 20px;
                border-radius: 16px;
            }
            
            /* Grid layout adjustments for mobile */
            .grid.grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: repeat(1, 1fr);
            }
            
            /* Form inputs */
            input, textarea, select {
                padding: 16px 12px;
                font-size: 16px;
                border-radius: 8px;
            }
            
            /* Buttons */
            button {
                padding: 16px 24px;
                font-size: 16px;
                min-height: 52px;
            }
            
            /* Admin button */
            .fixed.top-4.right-4 {
                top: 16px;
                right: 16px;
            }
            
            /* Contact grid */
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: repeat(1, 1fr);
                gap: 16px;
            }
            
            /* Visitor cards */
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: repeat(1, 1fr);
            }
            
            /* Admin panel table */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Modal adjustments */
            .print-modal .bg-white {
                margin: 16px;
                max-height: calc(100vh - 32px);
                border-radius: 16px;
            }
            
            /* Statistics cards */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(1, 1fr);
                gap: 16px;
            }
            
            /* Filter controls */
            .flex.flex-wrap.items-center.gap-4 {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }
            
            .flex.gap-2 {
                flex-direction: column;
                gap: 8px;
            }
            
            .flex.gap-2 button {
                width: 100%;
            }
        }
        
        /* Tablet Responsive Styles */
        @media (min-width: 641px) and (max-width: 1024px) {
            .gradient-bg {
                padding: 24px 20px;
            }
            
            .form-shadow {
                max-width: 600px;
                padding: 32px 28px;
            }
            
            /* Contact grid for tablet */
            .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            /* Statistics for tablet */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid.grid-cols-1.md\\:grid-cols-3 > :last-child {
                grid-column: span 2;
                max-width: 50%;
                margin: 0 auto;
            }
            
            /* Admin table horizontal scroll */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Filter controls for tablet */
            .flex.flex-wrap.items-center.justify-between {
                flex-direction: column;
                gap: 20px;
            }
            
            .flex.flex-wrap.items-center.gap-4 {
                justify-content: center;
            }
        }
        
        /* Large screens */
        @media (min-width: 1025px) {
            .gradient-bg {
                padding: 32px 16px;
            }
        }
        
        /* Print Styles - A4 Format */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }
            
            body * {
                visibility: hidden;
            }
            
            .print-content, .print-content * {
                visibility: visible;
            }
            
            .print-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 210mm;
                min-height: 297mm;
                margin: 0;
                padding: 0;
                background: white;
                font-size: 12pt;
                line-height: 1.4;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* Ensure proper page breaks */
            .print-content table {
                page-break-inside: auto;
            }
            
            .print-content tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            .print-content thead {
                display: table-header-group;
            }
            
            .print-content tfoot {
                display: table-footer-group;
            }
            
            /* Print-specific font sizes */
            .print-content h2 {
                font-size: 14pt !important;
            }
            
            .print-content h3 {
                font-size: 12pt !important;
            }
            
            .print-content p {
                font-size: 10pt !important;
            }
            
            .print-content table {
                font-size: 9pt !important;
            }
            
            .print-content th, .print-content td {
                font-size: 9pt !important;
                padding: 2mm !important;
            }
        }
        
        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .form-shadow {
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
            }
        }
        
        /* Landscape orientation on mobile */
        @media (max-width: 640px) and (orientation: landscape) {
            .bg-white\/10 {
                padding: 24px 20px;
            }
            
            .bg-white\/10 h1 {
                font-size: 2rem !important;
            }
            
            .bg-white\/10 h2 {
                font-size: 1.5rem !important;
            }
        }
        
        /* Focus styles for accessibility */
        button:focus, input:focus, textarea:focus, select:focus {
            outline: 2px solid #4F46E5;
            outline-offset: 2px;
        }
        
        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Prevent text selection on buttons */
        button {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen py-8 px-4">
    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <span>üì° Anda sedang offline - Data akan disimpan secara lokal</span>
    </div>
    
    <div class="max-w-6xl mx-auto">
        <!-- Admin Button -->
        <div class="fixed top-4 right-4 z-50">
            <button id="adminBtn" onclick="showAdminLogin()" 
                    class="bg-black bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition duration-200 backdrop-blur-sm">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
            <button id="logoutBtn" onclick="logout()" style="display: none;"
                    class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition duration-200 ml-2">
                Logout
            </button>
        </div>

        <!-- Thank You Notification -->
        <div id="thankYouNotification" class="thank-you-notification">
            <div class="flex items-start space-x-3">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </div>
                </div>
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-white mb-1">Terima Kasih! üôè</h4>
                    <p class="text-white text-opacity-90 text-sm leading-relaxed">Data kunjungan Anda telah berhasil dikirim. Selamat datang di SMAN 1 Kota Malang!</p>
                </div>
                <button onclick="hideThankYouNotification()" class="flex-shrink-0 text-white text-opacity-70 hover:text-opacity-100 transition-opacity">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Success Popup -->
        <div id="popupOverlay" class="popup-overlay"></div>
        <div id="successPopup" class="success-popup">
            <div class="checkmark-circle">
                <svg class="checkmark" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Berhasil!</h3>
            <p class="text-gray-600 text-lg">Data kunjungan Anda telah berhasil dikirim</p>
            <p class="text-gray-500 text-sm mt-2">Terima kasih atas kunjungan Anda</p>
        </div>

        <!-- Print Preview Modal -->
        <div id="printModal" class="print-modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center">
            <div class="bg-white rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4 no-print">
                    <h2 class="text-2xl font-bold text-gray-800">Preview Laporan</h2>
                    <div class="flex space-x-2">
                        <button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                            Print
                        </button>
                        <button onclick="closePrintModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg font-semibold">
                            Tutup
                        </button>
                    </div>
                </div>
                <div id="printContent" class="print-content">
                    <!-- Print content will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Admin Login Modal -->
        <div id="adminLoginModal" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden flex items-center justify-center">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Login Admin</h2>
                <form id="adminLoginForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Username</label>
                        <input type="text" id="adminUsername" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                        <input type="password" id="adminPassword" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div class="flex space-x-4">
                        <button type="submit" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-lg font-semibold">
                            Login
                        </button>
                        <button type="button" onclick="hideAdminLogin()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-3 rounded-lg font-semibold">
                            Batal
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Guest Book Section -->
        <div id="guestBookSection" class="guest-book">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 mb-6">
                    <h1 class="text-5xl font-bold text-white mb-4">Selamat Datang</h1>
                    <h2 class="text-3xl font-semibold text-white/95 mb-3">di SMAN 1 Kota Malang</h2>
                    <div class="pt-4 mt-4">
                        <p class="text-2xl font-medium text-yellow-200 italic">"Salam Mitreka Satata"</p>
                    </div>
                </div>
                <h3 class="text-3xl font-bold text-white mb-2">Buku Tamu Digital</h3>
                <p class="text-white/80 text-lg">Silakan isi form di bawah ini untuk mencatat kunjungan Anda</p>
            </div>

            <!-- Success Message -->
            <div id="successMessage" class="success-message bg-green-500 text-white p-4 rounded-lg mb-6 text-center">
                <div class="flex items-center justify-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Data berhasil dikirim! Terima kasih atas kunjungan Anda.</span>
                </div>
            </div>

            <!-- Form and Visitor List Container -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
                <!-- Form -->
                <div class="bg-white rounded-2xl p-8 form-shadow">
                    <form id="guestForm" class="space-y-6">
                        <!-- Nama Lengkap -->
                        <div>
                            <label for="namaLengkap" class="block text-sm font-semibold text-gray-700 mb-2">
                                Nama Lengkap <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="namaLengkap" name="namaLengkap" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
                                   placeholder="Masukkan nama lengkap Anda">
                        </div>

                        <!-- No. Telepon -->
                        <div>
                            <label for="noTelepon" class="block text-sm font-semibold text-gray-700 mb-2">
                                No. Telepon <span class="text-red-500">*</span>
                            </label>
                            <input type="tel" id="noTelepon" name="noTelepon" required
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200"
                                   placeholder="Contoh: 08123456789"
                                   pattern="[0-9]+"
                                   inputmode="numeric"
                                   oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                   title="Hanya boleh diisi dengan angka">
                        </div>

                        <!-- Alamat/Instansi -->
                        <div>
                            <label for="alamatInstansi" class="block text-sm font-semibold text-gray-700 mb-2">
                                Alamat/Instansi <span class="text-red-500">*</span>
                            </label>
                            <textarea id="alamatInstansi" name="alamatInstansi" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 resize-none"
                                      placeholder="Masukkan alamat lengkap atau nama instansi"></textarea>
                        </div>

                        <!-- Jenis Kelamin -->
                        <div>
                            <label for="jenisKelamin" class="block text-sm font-semibold text-gray-700 mb-2">
                                Jenis Kelamin <span class="text-red-500">*</span>
                            </label>
                            <select id="jenisKelamin" name="jenisKelamin" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200">
                                <option value="">Pilih jenis kelamin</option>
                                <option value="Laki-laki">Laki-laki</option>
                                <option value="Perempuan">Perempuan</option>
                            </select>
                        </div>

                        <!-- Keperluan Kunjungan -->
                        <div>
                            <label for="keperluanKunjungan" class="block text-sm font-semibold text-gray-700 mb-2">
                                Keperluan Kunjungan <span class="text-red-500">*</span>
                            </label>
                            <select id="keperluanKunjungan" name="keperluanKunjungan" required
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200">
                                <option value="">Pilih keperluan kunjungan</option>
                                <option value="Bertemu Kepala Sekolah">Bertemu Kepala Sekolah</option>
                                <option value="Bertemu WAKA SARPRAS">Bertemu WAKA SARPRAS</option>
                                <option value="Bertemu WAKA KURIKULUM">Bertemu WAKA KURIKULUM</option>
                                <option value="Bertemu WAKA KESISWAAN">Bertemu WAKA KESISWAAN</option>
                                <option value="Bertemu HUMAS">Bertemu HUMAS</option>
                                <option value="Bertemu Guru">Bertemu Guru</option>
                                <option value="Bertemu Siswa">Bertemu Siswa</option>
                                <option value="Urusan Administrasi">Urusan Administrasi</option>
                                <option value="Kunjungan Resmi">Kunjungan Resmi</option>
                                <option value="Penelitian/Survey">Penelitian/Survey</option>
                                <option value="Wawancara">Wawancara</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>

                        <!-- Tanggal Kunjungan -->
                        <div>
                            <label for="tanggalKunjungan" class="block text-sm font-semibold text-gray-700 mb-2">
                                Tanggal Kunjungan <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="tanggalKunjungan" name="tanggalKunjungan" required readonly
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700 cursor-not-allowed transition duration-200"
                                   placeholder="Tanggal akan terisi otomatis">
                        </div>

                        <!-- Keterangan Tambahan -->
                        <div>
                            <label for="keteranganTambahan" class="block text-sm font-semibold text-gray-700 mb-2">
                                Keterangan Tambahan <span class="text-red-500">*</span>
                            </label>
                            <textarea id="keteranganTambahan" name="keteranganTambahan" required rows="3"
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 resize-none"
                                      placeholder="Masukkan keterangan tambahan atau tujuan spesifik kunjungan"></textarea>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button type="submit" id="submitBtn"
                                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-6 rounded-lg transition duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                                <span id="submitText">Kirim Data Kunjungan</span>
                                <div id="loadingSpinner" class="loading"></div>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Visitor List -->
                <div class="bg-white rounded-2xl p-8 form-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">Daftar Tamu Hari Ini</h3>
                        <div class="bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-semibold">
                            <span id="totalVisitors">0</span> Tamu
                        </div>
                    </div>
                    
                    <div id="visitorList" class="space-y-4">
                        <div class="text-center py-8 text-gray-500">
                            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="text-lg">Belum ada tamu yang berkunjung hari ini</p>
                            <p class="text-sm text-gray-400 mt-1">Daftar tamu akan muncul setelah ada yang mengisi form</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="text-center mt-8">
                <div class="bg-white/10 backdrop-blur-sm rounded-2xl p-8 mb-6">
                    <div class="flex items-center justify-center mb-6">
                        <div class="bg-white/20 p-3 rounded-full mr-4">
                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-white">Hubungi Kami</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-white/90">
                        <!-- Alamat -->
                        <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-300">
                            <div class="flex flex-col items-center text-center">
                                <div class="bg-blue-500/20 p-3 rounded-full mb-3">
                                    <svg class="w-6 h-6 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <h4 class="font-semibold text-white mb-2">Alamat</h4>
                                <p class="text-sm text-white/80 leading-relaxed">
                                    Jl. Tugu Utara No.1<br>
                                    Klojen, Kota Malang<br>
                                    Jawa Timur 65111
                                </p>
                            </div>
                        </div>

                        <!-- Telepon -->
                        <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-300">
                            <div class="flex flex-col items-center text-center">
                                <div class="bg-green-500/20 p-3 rounded-full mb-3">
                                    <svg class="w-6 h-6 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                </div>
                                <h4 class="font-semibold text-white mb-2">Telepon</h4>
                                <p class="text-sm text-white/80">
                                    <a href="tel:+62341366454" class="hover:text-white transition-colors duration-200">
                                        (0341) 366454
                                    </a>
                                </p>
                                <p class="text-xs text-white/60 mt-1">Senin - Jumat<br>06:30 - 15:00 WIB</p>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-300">
                            <div class="flex flex-col items-center text-center">
                                <div class="bg-purple-500/20 p-3 rounded-full mb-3">
                                    <svg class="w-6 h-6 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <h4 class="font-semibold text-white mb-2">Email</h4>
                                <div class="text-sm text-white/80 space-y-1">
                                    <p>
                                        <a href="mailto:mitrekasatata@sman1-mlg.sch.id" class="hover:text-white transition-colors duration-200 break-all">
                                            mitrekasatata@sman1-mlg.sch.id
                                        </a>
                                    </p>
                                    <p>
                                        <a href="mailto:tu_sman1malang@yahoo.com" class="hover:text-white transition-colors duration-200">
                                            tu_sman1malang@yahoo.com
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Website -->
                        <div class="bg-white/5 rounded-xl p-4 hover:bg-white/10 transition-all duration-300">
                            <div class="flex flex-col items-center text-center">
                                <div class="bg-orange-500/20 p-3 rounded-full mb-3">
                                    <svg class="w-6 h-6 text-orange-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9m0 9c-5 0-9-4-9-9s4-9 9-9"></path>
                                    </svg>
                                </div>
                                <h4 class="font-semibold text-white mb-2">Website</h4>
                                <p class="text-sm text-white/80">
                                    <a href="https://sman1-mlg.sch.id" target="_blank" class="hover:text-white transition-colors duration-200">
                                        sman1-mlg.sch.id
                                    </a>
                                </p>
                                <p class="text-xs text-white/60 mt-1">Informasi Sekolah<br>& Berita Terkini</p>
                            </div>
                        </div>
                    </div>

                    <!-- Social Media & Additional Info -->
                    <div class="border-t border-white/20 mt-8 pt-6">
                        <div class="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0">
                            <div class="text-sm text-white/70">
                                <span class="font-medium">Jam Operasional:</span> Senin - Jumat, 06:30 - 15:00 WIB
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white/5 backdrop-blur-sm rounded-xl p-4">
                    <p class="text-white/70 text-sm">
                        ¬© 2024 SMAN 1 Kota Malang - Sistem Buku Tamu Digital
                    </p>
                    <p class="text-white/50 text-xs mt-1">
                        "Salam Mitreka Satata" - Bersama Membangun Generasi Unggul
                    </p>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-panel">
            <div class="bg-white rounded-2xl p-8 form-shadow mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Dashboard Admin</h2>
                    <div class="flex space-x-4">
                        <button onclick="showGuestBook()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                            Kembali ke Buku Tamu
                        </button>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-50 p-6 rounded-lg border border-blue-200">
                        <div class="flex items-center">
                            <div class="bg-blue-500 p-3 rounded-full">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-blue-600">Tamu Hari Ini</p>
                                <p class="text-2xl font-bold text-blue-900" id="todayVisitors">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                        <div class="flex items-center">
                            <div class="bg-green-500 p-3 rounded-full">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-green-600">Total Bulan Ini</p>
                                <p class="text-2xl font-bold text-green-900" id="monthlyVisitors">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-6 rounded-lg border border-purple-200">
                        <div class="flex items-center">
                            <div class="bg-purple-500 p-3 rounded-full">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-purple-600">Total Keseluruhan</p>
                                <p class="text-2xl font-bold text-purple-900" id="totalAllVisitors">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter and Export -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex flex-wrap items-center gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Bulan</label>
                                <select id="filterMonth" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Semua Bulan</option>
                                    <option value="0">Januari</option>
                                    <option value="1">Februari</option>
                                    <option value="2">Maret</option>
                                    <option value="3">April</option>
                                    <option value="4">Mei</option>
                                    <option value="5">Juni</option>
                                    <option value="6">Juli</option>
                                    <option value="7">Agustus</option>
                                    <option value="8">September</option>
                                    <option value="9">Oktober</option>
                                    <option value="10">November</option>
                                    <option value="11">Desember</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tahun</label>
                                <select id="filterYear" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                    <option value="">Semua Tahun</option>
                                </select>
                            </div>
                            <div class="pt-6">
                                <button onclick="filterData()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold">
                                    Filter
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export Excel
                            </button>
                            <button onclick="exportToPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export PDF
                            </button>
                            <button onclick="printReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                                </svg>
                                Print
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Visitor List -->
                <div class="bg-white border border-gray-200 rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">Data Tamu</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Input</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Telepon</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alamat/Instansi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keperluan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tgl Kunjungan</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                </tr>
                            </thead>
                            <tbody id="adminVisitorList" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                        Tidak ada data tamu
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Admin credentials
        const ADMIN_USERNAME = 'admin';
        const ADMIN_PASSWORD = 'aansman1';
        let isAdminLoggedIn = false;
        let allVisitorData = [];

        // Show admin login modal
        function showAdminLogin() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        // Hide admin login modal
        function hideAdminLogin() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            document.getElementById('adminLoginForm').reset();
        }

        // Admin login form handler
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                hideAdminLogin();
                showAdminPanel();
                loadAdminData();
            } else {
                alert('Username atau password salah!');
            }
        });

        // Show admin panel
        function showAdminPanel() {
            document.getElementById('guestBookSection').classList.add('hide');
            document.getElementById('adminPanel').classList.add('show');
            document.getElementById('adminBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'inline-block';
        }

        // Show guest book
        function showGuestBook() {
            document.getElementById('guestBookSection').classList.remove('hide');
            document.getElementById('adminPanel').classList.remove('show');
            document.getElementById('adminBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
        }

        // Logout
        function logout() {
            isAdminLoggedIn = false;
            showGuestBook();
        }

        // Load admin data
        function loadAdminData() {
            // Load all visitor data from localStorage
            allVisitorData = [];
            const keys = Object.keys(localStorage);
            
            keys.forEach(key => {
                if (key.startsWith('visitorList_')) {
                    const dateStr = key.replace('visitorList_', '');
                    const visitors = JSON.parse(localStorage.getItem(key) || '[]');
                    visitors.forEach(visitor => {
                        allVisitorData.push({
                            ...visitor,
                            tanggal: dateStr
                        });
                    });
                }
            });

            // Also load today's data
            const today = new Date().toDateString();
            const todayVisitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
            todayVisitors.forEach(visitor => {
                allVisitorData.push({
                    ...visitor,
                    tanggal: today
                });
            });

            // Remove duplicates and sort by date
            allVisitorData = allVisitorData.filter((visitor, index, self) => 
                index === self.findIndex(v => v.nama === visitor.nama && v.tanggal === visitor.tanggal && v.waktu === visitor.waktu)
            );
            
            allVisitorData.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

            updateAdminStatistics();
            displayAdminVisitorList(allVisitorData);
            populateYearFilter();
        }

        // Update admin statistics
        function updateAdminStatistics() {
            const today = new Date().toDateString();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const todayCount = allVisitorData.filter(v => v.tanggal === today).length;
            const monthlyCount = allVisitorData.filter(v => {
                const visitorDate = new Date(v.tanggal);
                return visitorDate.getMonth() === currentMonth && visitorDate.getFullYear() === currentYear;
            }).length;
            const totalCount = allVisitorData.length;

            document.getElementById('todayVisitors').textContent = todayCount;
            document.getElementById('monthlyVisitors').textContent = monthlyCount;
            document.getElementById('totalAllVisitors').textContent = totalCount;
        }

        // Display admin visitor list
        function displayAdminVisitorList(visitors) {
            const tbody = document.getElementById('adminVisitorList');
            
            if (visitors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                            Tidak ada data tamu
                        </td>
                    </tr>
                `;
                return;
            }

            const rows = visitors.map((visitor, index) => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatDate(visitor.tanggal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${visitor.nama}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${visitor.noTelepon}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-xs truncate">${visitor.alamat}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${visitor.keperluan}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${visitor.tanggal || 'Tidak ada tanggal'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${visitor.waktu}</td>
                </tr>
            `).join('');

            tbody.innerHTML = rows;
        }

        // Populate year filter
        function populateYearFilter() {
            const yearSelect = document.getElementById('filterYear');
            const years = [...new Set(allVisitorData.map(v => new Date(v.tanggal).getFullYear()))].sort((a, b) => b - a);
            
            yearSelect.innerHTML = '<option value="">Semua Tahun</option>';
            years.forEach(year => {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            });
        }

        // Filter data
        function filterData() {
            const selectedMonth = document.getElementById('filterMonth').value;
            const selectedYear = document.getElementById('filterYear').value;

            let filteredData = allVisitorData;

            if (selectedMonth !== '') {
                filteredData = filteredData.filter(v => new Date(v.tanggal).getMonth() == selectedMonth);
            }

            if (selectedYear !== '') {
                filteredData = filteredData.filter(v => new Date(v.tanggal).getFullYear() == selectedYear);
            }

            displayAdminVisitorList(filteredData);
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Export to Excel
        function exportToExcel() {
            try {
                const selectedMonth = document.getElementById('filterMonth').value;
                const selectedYear = document.getElementById('filterYear').value;
                
                let dataToExport = [...allVisitorData];
                let filename = 'Laporan_Buku_Tamu_SMAN1_Malang';

                if (selectedMonth !== '' || selectedYear !== '') {
                    if (selectedMonth !== '') {
                        dataToExport = dataToExport.filter(v => new Date(v.tanggal).getMonth() == selectedMonth);
                    }
                    if (selectedYear !== '') {
                        dataToExport = dataToExport.filter(v => new Date(v.tanggal).getFullYear() == selectedYear);
                    }

                    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    
                    if (selectedMonth !== '' && selectedYear !== '') {
                        filename = `Laporan_Buku_Tamu_${monthNames[selectedMonth]}_${selectedYear}`;
                    } else if (selectedYear !== '') {
                        filename = `Laporan_Buku_Tamu_${selectedYear}`;
                    }
                }

                // Create CSV content as fallback
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "LAPORAN BUKU TAMU DIGITAL\n";
                csvContent += "SMAN 1 KOTA MALANG\n";
                csvContent += "Jl. Tugu Utara No.1, Klojen, Kota Malang, Jawa Timur 65111\n\n";
                csvContent += "No,Tanggal Input,Nama Lengkap,No. Telepon,Alamat/Instansi,Jenis Kelamin,Keperluan Kunjungan,Tanggal Kunjungan,Keterangan,Waktu Input\n";

                dataToExport.forEach((visitor, index) => {
                    const tanggalKunjungan = visitor.tanggal ? new Date(visitor.tanggal).toLocaleDateString('id-ID') : 'Tidak ada tanggal';
                    csvContent += `${index + 1},"${formatDate(visitor.tanggal)}","${visitor.nama}","${visitor.noTelepon}","${visitor.alamat}","${visitor.jenisKelamin}","${visitor.keperluan}","${tanggalKunjungan}","${visitor.keterangan}","${visitor.waktu}"\n`;
                });

                csvContent += `\nTotal Tamu:,${dataToExport.length}\n\n`;
                csvContent += "Kepala Sekolah\n\n\n";
                csvContent += "Dr. Basuki Agus Priyana Putra, M.Pd\n";
                csvContent += "NIP. 196808121994031008\n";

                // Try XLSX first, fallback to CSV
                if (typeof XLSX !== 'undefined') {
                    const excelData = [
                        ['LAPORAN BUKU TAMU DIGITAL'],
                        ['SMAN 1 KOTA MALANG'],
                        ['Jl. Tugu Utara No.1, Klojen, Kota Malang, Jawa Timur 65111'],
                        [''],
                        ['No', 'Tanggal Input', 'Nama Lengkap', 'No. Telepon', 'Alamat/Instansi', 'Jenis Kelamin', 'Keperluan Kunjungan', 'Tanggal Kunjungan', 'Keterangan', 'Waktu Input']
                    ];

                    dataToExport.forEach((visitor, index) => {
                        const tanggalKunjungan = visitor.tanggal ? new Date(visitor.tanggal).toLocaleDateString('id-ID') : 'Tidak ada tanggal';
                        excelData.push([
                            index + 1,
                            formatDate(visitor.tanggal),
                            visitor.nama,
                            visitor.noTelepon,
                            visitor.alamat,
                            visitor.jenisKelamin,
                            visitor.keperluan,
                            tanggalKunjungan,
                            visitor.keterangan,
                            visitor.waktu
                        ]);
                    });

                    excelData.push(['']);
                    excelData.push(['Total Tamu:', dataToExport.length]);
                    excelData.push(['']);
                    excelData.push(['Kepala Sekolah']);
                    excelData.push(['']);
                    excelData.push(['']);
                    excelData.push(['Dr. Basuki Agus Priyana Putra, M.Pd']);
                    excelData.push(['NIP. 196808121994031008']);

                    const ws = XLSX.utils.aoa_to_sheet(excelData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Laporan Buku Tamu');
                    XLSX.writeFile(wb, `${filename}.xlsx`);
                } else {
                    // Fallback to CSV download
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `${filename}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                alert('File berhasil diunduh!');
            } catch (error) {
                console.error('Export error:', error);
                alert('Terjadi kesalahan saat export. Silakan coba lagi.');
            }
        }

        // Export to PDF
        function exportToPDF() {
            try {
                const selectedMonth = document.getElementById('filterMonth').value;
                const selectedYear = document.getElementById('filterYear').value;
                
                let dataToExport = [...allVisitorData];
                let reportTitle = 'LAPORAN BUKU TAMU DIGITAL';

                if (selectedMonth !== '' || selectedYear !== '') {
                    if (selectedMonth !== '') {
                        dataToExport = dataToExport.filter(v => new Date(v.tanggal).getMonth() == selectedMonth);
                    }
                    if (selectedYear !== '') {
                        dataToExport = dataToExport.filter(v => new Date(v.tanggal).getFullYear() == selectedYear);
                    }

                    const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                    
                    if (selectedMonth !== '' && selectedYear !== '') {
                        reportTitle = `LAPORAN BUKU TAMU DIGITAL BULAN ${monthNames[selectedMonth].toUpperCase()} ${selectedYear}`;
                    } else if (selectedYear !== '') {
                        reportTitle = `LAPORAN BUKU TAMU DIGITAL TAHUN ${selectedYear}`;
                    }
                }

                if (typeof window.jspdf !== 'undefined') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4'); // A4 portrait format

                    // A4 dimensions: 210mm x 297mm
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 20;
                    const contentWidth = pageWidth - (2 * margin);

                    // Header
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('PEMERINTAH PROVINSI JAWA TIMUR', pageWidth/2, 25, { align: 'center' });
                    doc.text('DINAS PENDIDIKAN', pageWidth/2, 35, { align: 'center' });
                    doc.text('SMA NEGERI 1 KOTA MALANG', pageWidth/2, 45, { align: 'center' });
                    
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text('Jl. Tugu Utara No.1, Klojen, Kota Malang, Jawa Timur 65111', pageWidth/2, 55, { align: 'center' });
                    doc.text('Telepon: (0341) 366454 | Email: mitrekasatata@sman1-mlg.sch.id', pageWidth/2, 62, { align: 'center' });

                    // Line separator
                    doc.setLineWidth(0.5);
                    doc.line(margin, 70, pageWidth - margin, 70);
                    doc.setLineWidth(0.3);
                    doc.line(margin, 72, pageWidth - margin, 72);

                    // Report Title
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(reportTitle, pageWidth/2, 85, { align: 'center' });

                    // Table setup
                    let yPos = 100;
                    const rowHeight = 8;
                    const headerHeight = 10;
                    
                    // Table headers with proper A4 spacing
                    const headers = ['No', 'Tanggal Input', 'Nama Lengkap', 'No. Telepon', 'Alamat/Instansi', 'Keperluan', 'Waktu'];
                    const colWidths = [12, 25, 35, 25, 40, 30, 23]; // Total: 190mm (fits in content width)
                    
                    // Draw table header
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    
                    // Header background
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPos - 6, contentWidth, headerHeight, 'F');
                    
                    // Header borders
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.2);
                    let xPos = margin;
                    
                    headers.forEach((header, index) => {
                        doc.rect(xPos, yPos - 6, colWidths[index], headerHeight);
                        doc.text(header, xPos + 2, yPos - 1);
                        xPos += colWidths[index];
                    });

                    yPos += 6;

                    // Table data
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);

                    dataToExport.forEach((visitor, index) => {
                        // Check if we need a new page
                        if (yPos > pageHeight - 60) {
                            doc.addPage();
                            yPos = 30;
                            
                            // Redraw header on new page
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(9);
                            doc.setFillColor(240, 240, 240);
                            doc.rect(margin, yPos - 6, contentWidth, headerHeight, 'F');
                            
                            xPos = margin;
                            headers.forEach((header, colIndex) => {
                                doc.rect(xPos, yPos - 6, colWidths[colIndex], headerHeight);
                                doc.text(header, xPos + 2, yPos - 1);
                                xPos += colWidths[colIndex];
                            });
                            
                            yPos += 6;
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(8);
                        }

                        xPos = margin;
                        const rowData = [
                            (index + 1).toString(),
                            formatDate(visitor.tanggal),
                            visitor.nama.length > 18 ? visitor.nama.substring(0, 18) + '...' : visitor.nama,
                            visitor.noTelepon,
                            visitor.alamat.length > 20 ? visitor.alamat.substring(0, 20) + '...' : visitor.alamat,
                            visitor.keperluan.length > 15 ? visitor.keperluan.substring(0, 15) + '...' : visitor.keperluan,
                            visitor.waktu
                        ];

                        // Draw row borders and content
                        rowData.forEach((data, colIndex) => {
                            doc.rect(xPos, yPos - 6, colWidths[colIndex], rowHeight);
                            doc.text(data, xPos + 2, yPos - 1);
                            xPos += colWidths[colIndex];
                        });

                        yPos += rowHeight;
                    });

                    // Summary
                    yPos += 10;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text(`Total Tamu: ${dataToExport.length} orang`, margin, yPos);

                    // Signature area
                    yPos += 20;
                    const signatureX = pageWidth - 70;
                    
                    doc.setFont(undefined, 'normal');
                    doc.text('Malang, ' + new Date().toLocaleDateString('id-ID'), signatureX, yPos);
                    yPos += 8;
                    doc.text('Kepala Sekolah', signatureX, yPos);
                    yPos += 30;
                    doc.setFont(undefined, 'bold');
                    doc.text('Dr. Basuki Agus Priyana Putra, M.Pd', signatureX, yPos);
                    yPos += 8;
                    doc.setFont(undefined, 'normal');
                    doc.text('NIP. 196808121994031008', signatureX, yPos);

                    // Save PDF
                    const filename = selectedMonth !== '' && selectedYear !== '' ? 
                        `Laporan_Buku_Tamu_${new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' }).replace(' ', '_')}.pdf` :
                        'Laporan_Buku_Tamu_SMAN1_Malang.pdf';
                    
                    doc.save(filename);
                    alert('PDF berhasil diunduh!');
                } else {
                    // Fallback: show print dialog
                    printReport();
                }
            } catch (error) {
                console.error('PDF export error:', error);
                alert('Terjadi kesalahan saat export PDF. Menggunakan print sebagai alternatif.');
                printReport();
            }
        }

        // Initialize visitor counter and date display
        function initializeVisitorCounter() {
            // Load visitor count from localStorage
            const currentDate = new Date();
            const today = currentDate.toDateString();
            const storedDate = localStorage.getItem('visitorDate');
            let visitorCount = 0;
            
            if (storedDate === today) {
                visitorCount = parseInt(localStorage.getItem('visitorCount') || '0');
            } else {
                // New day, reset counter
                localStorage.setItem('visitorDate', today);
                localStorage.setItem('visitorCount', '0');
                localStorage.setItem('visitorList', JSON.stringify([]));
            }
            
            document.getElementById('totalVisitors').textContent = visitorCount;
            
            // Start real-time clock for visit date
            startRealTimeClock();
            
            // Load and display visitor list
            loadVisitorList();
        }

        // Set automatic visit date with current date and time
        function setAutomaticVisitDate() {
            const now = new Date();
            
            // Format date and time in Indonesian
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            
            const formattedDateTime = now.toLocaleDateString('id-ID', options);
            
            // Set the value to the input field
            document.getElementById('tanggalKunjungan').value = formattedDateTime;
        }

        // Start real-time clock for visit date
        function startRealTimeClock() {
            setAutomaticVisitDate(); // Set initial time
            
            // Update every second
            setInterval(() => {
                setAutomaticVisitDate();
            }, 1000);
        }
        
        // Load visitor list from localStorage
        function loadVisitorList() {
            const today = new Date().toDateString();
            const storedDate = localStorage.getItem('visitorDate');
            let visitors = [];
            
            if (storedDate === today) {
                visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
            }
            
            displayVisitorList(visitors);
        }
        
        // Display visitor list
        function displayVisitorList(visitors) {
            const visitorListContainer = document.getElementById('visitorList');
            
            if (visitors.length === 0) {
                visitorListContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p class="text-lg">Belum ada tamu yang berkunjung hari ini</p>
                        <p class="text-sm text-gray-400 mt-1">Daftar tamu akan muncul setelah ada yang mengisi form</p>
                    </div>
                `;
                return;
            }
            
            // Show only the last 4 visitors
            const recentVisitors = visitors.slice(0, 4);
            
            const visitorCards = recentVisitors.map((visitor, index) => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="bg-indigo-100 text-indigo-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold">
                                    ${index + 1}
                                </div>
                                <h4 class="font-semibold text-gray-800 text-lg">${visitor.nama}</h4>
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${visitor.jenisKelamin}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                                    </svg>
                                    <span>${visitor.noTelepon}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                    <span class="truncate">${visitor.alamat}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v2a2 2 0 01-2 2H10a2 2 0 01-2-2V6"></path>
                                    </svg>
                                    <span class="font-medium text-indigo-600">${visitor.keperluan}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 4v10a2 2 0 002 2h4a2 2 0 002-2V11M8 7h8"></path>
                                    </svg>
                                    <span class="font-medium text-purple-600">${visitor.tanggal ? new Date(visitor.tanggal).toLocaleDateString('id-ID') : 'Tidak ada tanggal'}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>${visitor.waktu}</span>
                                </div>
                            </div>
                            ${visitor.keterangan ? `
                                <div class="mt-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                    <p class="text-sm text-gray-700"><strong>Keterangan:</strong> ${visitor.keterangan}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            let finalContent = visitorCards;
            
            // Add "Lihat Semua" button if there are more than 4 visitors
            if (visitors.length > 4) {
                finalContent += `
                    <div class="text-center mt-4">
                        <button onclick="showAllVisitors()" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-4 py-2 rounded-lg font-semibold transition duration-200">
                            Lihat Semua Tamu (${visitors.length})
                        </button>
                    </div>
                `;
            }
            
            visitorListContainer.innerHTML = finalContent;
        }
        
        // Show all visitors function
        function showAllVisitors() {
            const today = new Date().toDateString();
            const storedDate = localStorage.getItem('visitorDate');
            let visitors = [];
            
            if (storedDate === today) {
                visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
            }
            
            displayAllVisitorList(visitors);
        }
        
        // Display all visitor list
        function displayAllVisitorList(visitors) {
            const visitorListContainer = document.getElementById('visitorList');
            
            const visitorCards = visitors.map((visitor, index) => `
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="bg-indigo-100 text-indigo-800 rounded-full w-8 h-8 flex items-center justify-center text-sm font-semibold">
                                    ${index + 1}
                                </div>
                                <h4 class="font-semibold text-gray-800 text-lg">${visitor.nama}</h4>
                                <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full">${visitor.jenisKelamin}</span>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm text-gray-600">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2-2v2m8 0H8m8 0v2a2 2 0 01-2 2H10a2 2 0 01-2-2V6"></path>
                                    </svg>
                                    <span class="font-medium text-indigo-600">${visitor.keperluan}</span>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>${visitor.waktu}</span>
                                </div>
                            </div>
                            ${visitor.keterangan ? `
                                <div class="mt-3 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                                    <p class="text-sm text-gray-700"><strong>Keterangan:</strong> ${visitor.keterangan}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            const finalContent = visitorCards + `
                <div class="text-center mt-4">
                    <button onclick="loadVisitorList()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold transition duration-200">
                        Tampilkan 4 Terbaru
                    </button>
                </div>
            `;
            
            visitorListContainer.innerHTML = finalContent;
        }
        
        // Update visitor counter and add to list
        function updateVisitorCounter(visitorData) {
            const today = new Date().toDateString();
            const storedDate = localStorage.getItem('visitorDate');
            let visitorCount = 0;
            let visitors = [];
            
            if (storedDate === today) {
                visitorCount = parseInt(localStorage.getItem('visitorCount') || '0') + 1;
                visitors = JSON.parse(localStorage.getItem('visitorList') || '[]');
            } else {
                visitorCount = 1;
                localStorage.setItem('visitorDate', today);
                visitors = [];
            }
            
            // Add new visitor to list
            const currentTime = new Date();
            const timeString = currentTime.toLocaleTimeString('id-ID', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const newVisitor = {
                nama: visitorData.nama,
                noTelepon: visitorData.noTelepon,
                alamat: visitorData.alamat,
                jenisKelamin: visitorData.jenisKelamin,
                keperluan: visitorData.keperluan,
                tanggal: visitorData.tanggal,
                keterangan: visitorData.keterangan,
                waktu: timeString
            };
            
            visitors.unshift(newVisitor); // Add to beginning of array
            
            // Save to localStorage
            localStorage.setItem('visitorCount', visitorCount.toString());
            localStorage.setItem('visitorList', JSON.stringify(visitors));
            
            // Also save with date key for admin access
            localStorage.setItem(`visitorList_${today}`, JSON.stringify(visitors));
            
            // Update total visitors display
            const totalElement = document.getElementById('totalVisitors');
            totalElement.textContent = visitorCount;
            
            // Update visitor list display
            displayVisitorList(visitors);
        }
        
        // Print Report
        function printReport() {
            const selectedMonth = document.getElementById('filterMonth').value;
            const selectedYear = document.getElementById('filterYear').value;
            
            let dataToExport = [...allVisitorData];
            let reportTitle = 'LAPORAN BUKU TAMU DIGITAL';

            if (selectedMonth !== '' || selectedYear !== '') {
                if (selectedMonth !== '') {
                    dataToExport = dataToExport.filter(v => new Date(v.tanggal).getMonth() == selectedMonth);
                }
                if (selectedYear !== '') {
                    dataToExport = dataToExport.filter(v => new Date(v.tanggal).getFullYear() == selectedYear);
                }

                const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                                  'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
                
                if (selectedMonth !== '' && selectedYear !== '') {
                    reportTitle = `LAPORAN BUKU TAMU DIGITAL BULAN ${monthNames[selectedMonth].toUpperCase()} ${selectedYear}`;
                } else if (selectedYear !== '') {
                    reportTitle = `LAPORAN BUKU TAMU DIGITAL TAHUN ${selectedYear}`;
                }
            }

            // Generate print content with A4 format
            const printContent = `
                <div style="font-family: 'Times New Roman', serif; width: 210mm; min-height: 297mm; margin: 0 auto; padding: 20mm; box-sizing: border-box; background: white;">
                    <!-- Header Section -->
                    <div style="text-align: center; margin-bottom: 25mm; border-bottom: 2px solid black; padding-bottom: 5mm;">
                        <h2 style="margin: 2mm 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">PEMERINTAH PROVINSI JAWA TIMUR</h2>
                        <h2 style="margin: 2mm 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">DINAS PENDIDIKAN</h2>
                        <h2 style="margin: 2mm 0; font-size: 14pt; font-weight: bold; line-height: 1.2;">SMA NEGERI 1 KOTA MALANG</h2>
                        <p style="margin: 3mm 0; font-size: 10pt; line-height: 1.2;">Jl. Tugu Utara No.1, Klojen, Kota Malang, Jawa Timur 65111</p>
                        <p style="margin: 3mm 0; font-size: 10pt; line-height: 1.2;">Telepon: (0341) 366454 | Email: mitrekasatata@sman1-mlg.sch.id</p>
                    </div>
                    
                    <!-- Report Title -->
                    <div style="text-align: center; margin-bottom: 15mm;">
                        <h3 style="margin: 0; font-size: 12pt; font-weight: bold; text-decoration: underline;">${reportTitle}</h3>
                    </div>
                    
                    <!-- Data Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 15mm; font-size: 9pt;">
                        <thead>
                            <tr style="background-color: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 8%;">No</th>
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 15%;">Tanggal Input</th>
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 20%;">Nama Lengkap</th>
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 15%;">No. Telepon</th>
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 20%;">Alamat/Instansi</th>
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 15%;">Keperluan</th>
                                <th style="border: 1px solid #000; padding: 3mm; text-align: center; font-weight: bold; width: 7%;">Waktu</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataToExport.map((visitor, index) => `
                                <tr>
                                    <td style="border: 1px solid #000; padding: 2mm; text-align: center; vertical-align: top;">${index + 1}</td>
                                    <td style="border: 1px solid #000; padding: 2mm; text-align: center; vertical-align: top;">${formatDate(visitor.tanggal)}</td>
                                    <td style="border: 1px solid #000; padding: 2mm; vertical-align: top;">${visitor.nama}</td>
                                    <td style="border: 1px solid #000; padding: 2mm; text-align: center; vertical-align: top;">${visitor.noTelepon}</td>
                                    <td style="border: 1px solid #000; padding: 2mm; vertical-align: top;">${visitor.alamat}</td>
                                    <td style="border: 1px solid #000; padding: 2mm; vertical-align: top;">${visitor.keperluan}</td>
                                    <td style="border: 1px solid #000; padding: 2mm; text-align: center; vertical-align: top;">${visitor.waktu}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <!-- Summary -->
                    <div style="margin-bottom: 20mm;">
                        <p style="font-size: 10pt; font-weight: bold; margin: 0;"><strong>Total Tamu: ${dataToExport.length} orang</strong></p>
                    </div>
                    
                    <!-- Signature Section -->
                    <div style="display: flex; justify-content: flex-end; margin-top: 20mm;">
                        <div style="text-align: center; width: 60mm;">
                            <p style="margin: 0; font-size: 10pt;">Malang, ${new Date().toLocaleDateString('id-ID')}</p>
                            <p style="margin: 3mm 0; font-size: 10pt;">Kepala Sekolah</p>
                            <div style="height: 20mm;"></div>
                            <p style="margin: 0; font-size: 10pt; font-weight: bold; text-decoration: underline;">Dr. Basuki Agus Priyana Putra, M.Pd</p>
                            <p style="margin: 2mm 0; font-size: 10pt;">NIP. 196808121994031008</p>
                        </div>
                    </div>
                </div>
            `;

            // Show print modal
            document.getElementById('printContent').innerHTML = printContent;
            document.getElementById('printModal').classList.add('show');
        }

        // Close print modal
        function closePrintModal() {
            document.getElementById('printModal').classList.remove('show');
        }

        // Show thank you notification
        function showThankYouNotification() {
            const notification = document.getElementById('thankYouNotification');
            notification.classList.add('show');
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                hideThankYouNotification();
            }, 3000);
        }

        // Hide thank you notification
        function hideThankYouNotification() {
            const notification = document.getElementById('thankYouNotification');
            notification.classList.add('hide');
            
            setTimeout(() => {
                notification.classList.remove('show', 'hide');
            }, 400);
        }

        // Show success popup
        function showSuccessPopup() {
            const overlay = document.getElementById('popupOverlay');
            const popup = document.getElementById('successPopup');
            
            overlay.classList.add('show');
            popup.classList.add('show');
            
            // Auto hide after 2 seconds
            setTimeout(() => {
                hideSuccessPopup();
            }, 2000);
        }

        // Hide success popup
        function hideSuccessPopup() {
            const overlay = document.getElementById('popupOverlay');
            const popup = document.getElementById('successPopup');
            
            popup.classList.add('hide');
            
            setTimeout(() => {
                overlay.classList.remove('show');
                popup.classList.remove('show', 'hide');
            }, 300);
        }

        // Offline functionality
        let isOnline = navigator.onLine;
        let offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');

        // Check online/offline status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const offlineIndicator = document.getElementById('offlineIndicator');
            
            if (isOnline) {
                offlineIndicator.classList.remove('show');
                // Process offline queue when back online
                processOfflineQueue();
            } else {
                offlineIndicator.classList.add('show');
            }
        }

        // Process offline queue
        function processOfflineQueue() {
            if (offlineQueue.length > 0) {
                console.log('Processing offline queue:', offlineQueue.length, 'items');
                
                offlineQueue.forEach(async (queueItem, index) => {
                    try {
                        const response = await fetch(queueItem.url, queueItem.options);
                        if (response.ok) {
                            console.log('Successfully synced offline data:', index);
                        }
                    } catch (error) {
                        console.error('Failed to sync offline data:', error);
                    }
                });
                
                // Clear queue after processing
                offlineQueue = [];
                localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
                
                // Show sync success message
                showSyncSuccessMessage();
            }
        }

        // Show sync success message
        function showSyncSuccessMessage() {
            const message = document.createElement('div');
            message.className = 'fixed top-16 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            message.innerHTML = '‚úÖ Data offline berhasil disinkronkan';
            document.body.appendChild(message);
            
            setTimeout(() => {
                message.remove();
            }, 3000);
        }

        // Add to offline queue
        function addToOfflineQueue(url, options, visitorData) {
            const queueItem = {
                url: url,
                options: options,
                visitorData: visitorData,
                timestamp: new Date().toISOString()
            };
            
            offlineQueue.push(queueItem);
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            
            // Don't update visitor counter here - it's already done before submission
        }

        // Enhanced form submission with offline support
        function submitFormWithOfflineSupport(formData, visitorData) {
            const url = 'https://script.google.com/macros/s/AKfycbxleYv7IrHt3q85qqptgf9hUqL1n-E3giSvFWFOCYjWW7SXwb54C6476olBrx61Qq9W/exec';
            const options = {
                method: 'POST',
                body: formData
            };

            if (isOnline) {
                // Try to submit online
                return fetch(url, options)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.text();
                    })
                    .catch(error => {
                        console.error('Online submission failed, adding to offline queue:', error);
                        addToOfflineQueue(url, options, visitorData);
                        throw error;
                    });
            } else {
                // Add to offline queue
                addToOfflineQueue(url, options, visitorData);
                return Promise.resolve('Data saved offline');
            }
        }

        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeVisitorCounter();
            updateOnlineStatus();
        });

        document.getElementById('guestForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const successMessage = document.getElementById('successMessage');
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = isOnline ? 'Mengirim Data...' : 'Menyimpan Offline...';
            loadingSpinner.classList.add('show');
            
            // Hide previous success message
            successMessage.classList.remove('show');
            
            // Get current timestamp for submission
            const currentTimestamp = new Date();
            const timestampOptions = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            const currentFormattedDateTime = currentTimestamp.toLocaleDateString('id-ID', timestampOptions);

            // Prepare visitor data
            const visitorData = {
                nama: document.getElementById('namaLengkap').value,
                noTelepon: document.getElementById('noTelepon').value,
                alamat: document.getElementById('alamatInstansi').value,
                jenisKelamin: document.getElementById('jenisKelamin').value,
                keperluan: document.getElementById('keperluanKunjungan').value,
                tanggal: currentFormattedDateTime,
                keterangan: document.getElementById('keteranganTambahan').value
            };
            
            // Prepare form data
            const formData = new FormData();
            formData.append('Nama Lengkap', visitorData.nama);
            formData.append('No. Telepon', visitorData.noTelepon);
            formData.append('Alamat/Instansi', visitorData.alamat);
            formData.append('Jenis Kelamin', visitorData.jenisKelamin);
            formData.append('Keperluan Kunjungan', visitorData.keperluan);
            formData.append('Tgl', currentFormattedDateTime);
            formData.append('Keterangan Tambahan', visitorData.keterangan);
            
            // Update visitor counter and list FIRST
            updateVisitorCounter(visitorData);
            
            // Use enhanced form submission with offline support
            submitFormWithOfflineSupport(formData, visitorData)
            .then(data => {
                // Reset form
                this.reset();
                
                // Restart the real-time clock after form reset
                startRealTimeClock();
                
                console.log('Success:', data);
                
                // Show thank you notification
                showThankYouNotification();
                
                // Show appropriate message based on online status
                if (!isOnline) {
                    const offlineMessage = document.createElement('div');
                    offlineMessage.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-orange-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    offlineMessage.innerHTML = 'üíæ Data disimpan offline dan akan dikirim saat online';
                    document.body.appendChild(offlineMessage);
                    
                    setTimeout(() => {
                        offlineMessage.remove();
                    }, 4000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                
                if (isOnline) {
                    // Show error message for online failures
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    errorMessage.innerHTML = '‚ùå Gagal mengirim data. Data disimpan offline.';
                    document.body.appendChild(errorMessage);
                    
                    setTimeout(() => {
                        errorMessage.remove();
                    }, 4000);
                    
                    // Reset form since data is saved locally
                    this.reset();
                    startRealTimeClock();
                } else {
                    // For offline, this is expected behavior
                    this.reset();
                    startRealTimeClock();
                }
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                submitText.textContent = 'Kirim Data Kunjungan';
                loadingSpinner.classList.remove('show');
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96abbbd8c025fde6',t:'MTc1NDQ1Mzk0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
